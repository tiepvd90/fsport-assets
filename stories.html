<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Stories - Funsport</title>

  <!-- ✅ Font Be Vietnam Pro -->
  <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="/stories/css/stories.css">

  
  <style>
    .story-feed-container {
      max-width: 720px;
      margin: 0 auto;
      padding-bottom: 80px;
    }

    .story-item {
      padding: 16px 0;
      border-bottom: 1px solid #ddd;
    }

    .story-item h2 {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 6px;
      color: #111;
    }

    .story-item p {
      font-size: 15px;
      color: #555;
      margin-bottom: 8px;
    }

    .story-item img {
      width: 100%;
      border-radius: 8px;
      margin: 12px 0;
    }

    #loadMoreBtn {
      display: block;
      margin: 24px auto;
      padding: 10px 16px;
      border: none;
      background: #eee;
      color: #333;
      font-size: 14px;
      border-radius: 8px;
      cursor: pointer;
    }

    #loadMoreBtn:hover {
      background: #ddd;
    }
  </style>
</head>
<body>

  <div class="story-feed-container" id="storyFeed"></div>
  <button id="loadMoreBtn">Xem thêm</button>

  <!-- Sticky footer -->
  <div id="footerContainer"></div>
  <script>
    fetch('/stories/html/stickyfooter-stories.html')
      .then(res => res.text())
      .then(html => {
        document.getElementById('footerContainer').innerHTML = html;
      });
  </script>

  <!-- Lazyload dữ liệu -->
  <script>
const API_URL = "https://script.google.com/macros/s/AKfycbyh33sEGcoURPCnYw34NKnDMEIJe9D_x04f4cwExYxQXV_RWZWfSPJbZjOMk_SK6f2o/exec"; // ← thay bằng link của bạn nếu cần
const CACHE_KEY = "storiesCache";
const CACHE_TTL = 30 * 60 * 1000; // 30 phút

let storiesData = [];
let batchSize = 6;
let currentIndex = 0;
let observer;

function getIdNumber(id) {
  return parseInt(String(id || '').replace(/\D/g, ''), 10) || 0;
}

function renderNextBatch() {
  const container = document.getElementById('storyFeed');
  const nextItems = storiesData.slice(currentIndex, currentIndex + batchSize);

  nextItems.forEach(item => {
    const html = `
      <div class="story-item">
        ${item.link ? `<a href="${item.link}" style="text-decoration: none;">` : ''}
          <h2>${item.title}</h2>
          <p>${item.intro}</p>
          <img src="${item.image}" loading="lazy" alt="${item.title}">
        ${item.link ? `</a>` : ''}
      </div>
    `;
    container.insertAdjacentHTML('beforeend', html);
  });

  currentIndex += batchSize;

  if (currentIndex >= storiesData.length && observer) {
    observer.disconnect();
  }
}

function setupLazyLoad() {
  const sentinel = document.createElement('div');
  sentinel.id = 'lazySentinel';
  document.getElementById('storyFeed').appendChild(sentinel);

  observer = new IntersectionObserver((entries) => {
    if (entries[0].isIntersecting) {
      renderNextBatch();
    }
  }, {
    rootMargin: '100px'
  });

  observer.observe(sentinel);
}

function loadCache() {
  try {
    const raw = localStorage.getItem(CACHE_KEY);
    if (!raw) return null;
    const parsed = JSON.parse(raw);
    if (Date.now() - parsed.timestamp > CACHE_TTL) return null;
    return parsed.data;
  } catch {
    return null;
  }
}

function saveCache(data) {
  try {
    const payload = {
      timestamp: Date.now(),
      data
    };
    localStorage.setItem(CACHE_KEY, JSON.stringify(payload));
  } catch {}
}

async function fetchStories() {
  const cached = loadCache();
  if (cached) {
    storiesData = cached
      .filter(item => item.id && item.title && item.image && item.intro)
      .sort((a, b) => getIdNumber(b.id) - getIdNumber(a.id));
    renderNextBatch();
    setupLazyLoad();
    return;
  }

  try {
    const res = await fetch(API_URL);
    const data = await res.json();

    storiesData = data
      .filter(item => item.id && item.title && item.image && item.intro)
      .sort((a, b) => getIdNumber(b.id) - getIdNumber(a.id));

    saveCache(storiesData);
    renderNextBatch();
    setupLazyLoad();
  } catch (err) {
    console.error("Lỗi khi tải dữ liệu stories:", err);
    document.getElementById('storyFeed').innerHTML = "<p style='color:red;'>Không thể tải dữ liệu bài viết.</p>";
  }
}

window.addEventListener('DOMContentLoaded', fetchStories);

// Ẩn nút Xem thêm nếu có
document.addEventListener('DOMContentLoaded', () => {
  const btn = document.getElementById('loadMoreBtn');
  if (btn) btn.style.display = 'none';
});
</script>

<!-- ✅ Sticky footer -->
<div id="footerContainer"></div>
<script src="https://unpkg.com/lucide@latest"></script>
<script>
  fetch('/stories/html/stickyfooter-stories.html')
    .then(res => res.text())
    .then(html => {
      document.getElementById('footerContainer').innerHTML = html;
      lucide.createIcons();
    });
</script>
</body>
</html>
